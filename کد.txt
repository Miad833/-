<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>سیستم ثبت سفارش و مدیریت فروش</title>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#9aa6b2; --accent:#3ddc97; --accent2:#3ea7ff; --accent3:#ffd166;
      --glass: rgba(255,255,255,0.03);
      --success: #32d296; --danger:#ff6b6b;
      font-family: 'Vazirmatn', 'Segoe UI', Tahoma, sans-serif;
    }
    html,body{height:100%;margin:0;background:linear-gradient(135deg,#021024 0%, #07283a 50%, #03121b 100%);color:#e6eef6}
    .app{max-width:1200px;margin:28px auto;padding:24px;}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent2),var(--accent));display:flex;align-items:center;justify-content:center;font-weight:700;color:#021;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    h1{margin:0;font-size:20px}
    p.lead{margin:0;color:var(--muted)}

    .top-controls{display:flex;gap:12px;align-items:center}
    .btn{background:var(--accent2);border:none;padding:10px 14px;border-radius:10px;color:#022;cursor:pointer;font-weight:600}
    .btn.alt{background:var(--accent);color:#012}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}

    .layout{display:grid;grid-template-columns:360px 1fr;gap:20px;margin-top:20px}

    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:14px;box-shadow:0 6px 30px rgba(2,6,23,0.6);}
    .sidebar .section{margin-bottom:16px}
    label{display:block;margin-bottom:6px;color:var(--muted);font-size:13px}
    input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .small{font-size:13px;color:var(--muted)}

    .orders-list{display:flex;flex-direction:column;gap:10px}
    .order-item{display:flex;justify-content:space-between;gap:12px;padding:12px;border-radius:10px;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));align-items:center}
    .badge{padding:6px 10px;border-radius:999px;font-size:13px;font-weight:700}
    .status-pending{background:rgba(255,255,255,0.05);color:var(--muted)}
    .status-sales{background:rgba(62,167,255,0.15);color:var(--accent2)}
    .status-fin{background:rgba(61,220,151,0.12);color:var(--accent)}
    .status-done{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#012}
    .meta{font-size:13px;color:var(--muted)}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;text-align:right;border-bottom:1px dashed rgba(255,255,255,0.03)}

    .flex{display:flex;gap:10px;align-items:center}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}

    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}

    /* responsive */
    @media (max-width:900px){.layout{grid-template-columns:1fr;}.brand h1{font-size:16px}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo">س</div>
        <div>
          <h1>سامانه هوشمند ثبت سفارش</h1>
          <p class="lead">جریان سفارش از تماس تا صدور فاکتور — پیاده‌سازی شبیه‌سازی به‌صورت تک فایل</p>
        </div>
      </div>
      <div class="top-controls">
        <div class="small">نمایش بعنوان:</div>
        <select id="actorSelect">
          <option value="customer">مشتری</option>
          <option value="sales">مسئول فروش</option>
          <option value="finance">مسئول مالی</option>
          <option value="manager">مدیر بازرگانی</option>
          <option value="warehouse">انباردار</option>
        </select>
        <button class="btn ghost" id="btnLogout">خروج</button>
        <button class="btn alt" id="btnOpenRegister">ورود / ثبت‌نام</button>
      </div>
    </header>

    <div class="layout">
      <aside class="sidebar">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div id="welcomeLine">وارد نشده‌اید</div>
              <div class="small">شناسه کاربر: <span id="userId">—</span></div>
            </div>
            <div class="flex">
              <button class="btn" id="btnNewOrder">ثبت سفارش جدید</button>
            </div>
          </div>

          <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">

          <div class="section">
            <div class="small">جستجو سفارش</div>
            <input id="searchOrder" placeholder="شماره یا نام مشتری" />
          </div>

          <div class="section">
            <div class="small">فیلتر وضعیت</div>
            <select id="filterStatus">
              <option value="all">همه</option>
              <option value="requested">درخواست شده</option>
              <option value="approved">تایید فروش</option>
              <option value="finance_ok">تایید مالی</option>
              <option value="manager_ok">تایید مدیریت</option>
              <option value="shipped">ارسال شده</option>
              <option value="invoiced">فاکتور شده</option>
              <option value="delivered">تحویل شده</option>
            </select>
          </div>

          <div class="section">
            <div class="small">سفارش‌های اخیر</div>
            <div id="recentList" class="orders-list" style="margin-top:8px"></div>
          </div>
        </div>
      </aside>

      <main>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3 style="margin:0">فهرست سفارش‌ها</h3>
            <div class="small">برای اجرای هر عملیات، از منوی سمت راست نقش مورد نظر را انتخاب کنید.</div>
          </div>

          <div style="margin-top:14px">
            <table id="ordersTable">
              <thead>
                <tr><th>شماره</th><th>مشتری</th><th>مبلغ کل</th><th>وضعیت</th><th>اقدامات</th></tr>
              </thead>
              <tbody id="ordersTbody"></tbody>
            </table>
          </div>

        </div>

        <div class="card" style="margin-top:16px">
          <h3 style="margin-top:0">لاگ عملیات</h3>
          <div id="logArea" style="max-height:220px;overflow:auto;padding:8px;background:var(--glass);border-radius:8px"></div>
        </div>

      </main>
    </div>

    <footer>نسخه نمایشی — داده‌ها در مرورگر ذخیره می‌شوند (localStorage). برای اجرای در ویژوال استودیو: این فایل را با اسم <code>order_system.html</code> ذخیره کنید و با Live Server یا مرورگر باز کنید.</footer>
  </div>

  <!-- modals -->
  <div id="modalRoot"></div>

  <script>
    // Helper: localStorage simple DB
    const DB = {
      usersKey:'os_users_v1', ordersKey:'os_orders_v1', logsKey:'os_logs_v1', currentKey:'os_current_v1',
      save(key,val){localStorage.setItem(key,JSON.stringify(val));},
      load(key,def){const v=localStorage.getItem(key);return v?JSON.parse(v):def},
    }

    // init
    if(!DB.load(DB.usersKey,[]).length){
      // create demo user
      DB.save(DB.usersKey,[{id:1,username:'demo',password:'demo',name:'مشتری نمونه',family:'نمونه',national:'0011223344',phone:'09120000000'}]);
    }

    // state
    let state = {
      currentUser: DB.load(DB.currentKey,null),
      actor: 'sales',
      orders: DB.load(DB.ordersKey,[]),
      logs: DB.load(DB.logsKey,[]),
    };

    const el = id => document.getElementById(id);
    const actorSelect = el('actorSelect');
    actorSelect.value = state.actor;

    function saveAll(){ DB.save(DB.ordersKey,state.orders); DB.save(DB.logsKey,state.logs); DB.save(DB.currentKey,state.currentUser); }

    // UI updates
    function renderWelcome(){
      const w = el('welcomeLine');
      if(state.currentUser){ w.textContent = state.currentUser.name + ' ' + state.currentUser.family; el('userId').textContent = state.currentUser.username; }
      else { w.textContent='حساب کاربری وارد نشده'; el('userId').textContent='—'; }
    }

    function statusLabel(s){
      const map = {requested:['درخواست شده','status-pending'], approved:['تایید فروش','status-sales'], finance_ok:['تایید مالی','status-fin'], manager_ok:['تایید مدیریت','status-fin'], shipped:['ارسال شده','status-sales'], invoiced:['فاکتور شده','status-done'], delivered:['تحویل شده','status-done']}
      return map[s]||['نامشخص','status-pending'];
    }

    function renderRecent(){
      const root = el('recentList'); root.innerHTML='';
      const items = state.orders.slice().reverse().slice(0,6);
      items.forEach(o=>{
        const div = document.createElement('div'); div.className='order-item';
        const st = statusLabel(o.status);
        div.innerHTML = `<div><div style="font-weight:700">#${o.id} — ${o.customerName}</div><div class="meta">${new Date(o.createdAt).toLocaleString('fa-IR')}</div></div><div class="badge ${st[1]}">${st[0]}</div>`;
        root.appendChild(div);
      })
    }

    function renderOrders(filter='all'){
      const tbody = el('ordersTbody'); tbody.innerHTML='';
      const q = el('searchOrder').value.trim().toLowerCase();
      const list = state.orders.filter(o=> {
        if(filter!=='all' && o.status !== filter) return false;
        if(!q) return true;
        return (''+o.id).includes(q) || o.customerName.toLowerCase().includes(q) || (o.customerPhone||'').includes(q);
      });
      list.forEach(o=>{
        const tr = document.createElement('tr');
        const total = o.items.reduce((s,i)=>s + (i.price * i.qty),0);
        const st = statusLabel(o.status);
        tr.innerHTML = `<td>#${o.id}</td><td>${o.customerName}<div class="small">${o.customerPhone||''}</div></td><td>${total.toLocaleString()} تومان</td><td><div class="badge ${st[1]}">${st[0]}</div></td><td></td>`;
        const actionTd = tr.querySelector('td:last-child');
        // actions based on actor and status
        const actor = state.actor;
        const btns = [];
        if(actor==='sales' && o.status==='requested') btns.push({t:'تایید سفارش',fn:()=>advanceOrder(o.id,'approved')});
        if(actor==='finance' && (o.status==='approved' || o.status==='requested')) btns.push({t:'بررسی وضع حساب و تایید مالی',fn:()=>advanceOrder(o.id,'finance_ok')});
        if(actor==='manager' && o.status==='finance_ok') btns.push({t:'تصمیم مدیر: ارسال / رد',fn:()=>advanceOrder(o.id,'manager_ok')});
        if(actor==='sales' && o.status==='manager_ok') btns.push({t:'ارسال به انبار',fn:()=>advanceOrder(o.id,'shipped')});
        if(actor==='warehouse' && o.status==='shipped') btns.push({t:'ارسال محصول (انبار)',fn:()=>advanceOrder(o.id,'invoiced')});
        if(actor==='finance' && o.status==='invoiced') btns.push({t:'صدور فاکتور رسمی',fn:()=>generateInvoice(o.id)});
        if(actor==='customer' && o.status==='invoiced') btns.push({t:'تایید رسید و تحویل',fn:()=>advanceOrder(o.id,'delivered')});
        // view details always
        btns.push({t:'جزئیات',fn:()=>openOrderDetails(o.id)});
        btns.forEach(b=>{const btn=document.createElement('button');btn.className='btn ghost';btn.style.marginLeft='6px';btn.textContent=b.t;btn.onclick=b.fn;actionTd.appendChild(btn)});
        tbody.appendChild(tr);
      })
    }

    function renderLog(){ const root=el('logArea'); root.innerHTML=''; state.logs.slice().reverse().forEach(l=>{ const d = new Date(l.time).toLocaleString('fa-IR'); root.innerHTML += `<div style="padding:6px 0;border-bottom:1px dashed rgba(255,255,255,0.02)"><div style="font-weight:700">${l.by} — ${l.title}</div><div class="small">${d} · ${l.note||''}</div></div>`; }); }

    function addLog(title,note){ state.logs.push({time:Date.now(),by:(state.currentUser?state.currentUser.username:state.actor),title,note}); saveAll(); renderLog(); }

    // actions
    function advanceOrder(id,newStatus){ const o = state.orders.find(x=>x.id===id); if(!o) return alert('سفارش پیدا نشد'); o.status = newStatus; state.orders = state.orders.map(x=> x.id===id?o:x); addLog(`سفارش #${id} — تغییر وضعیت به ${newStatus}`,`توسط ${state.actor}`); saveAll(); renderAll(); }

    function generateInvoice(id){ const o = state.orders.find(x=>x.id===id); if(!o) return; o.status='invoiced'; saveAll(); addLog(`فاکتور صادر شد برای سفارش #${id}`); // quick invoice modal
      const total = o.items.reduce((s,i)=>s + i.price*i.qty,0);
      openModal('فاکتور رسمی',{html:`<div>سفارش: #${o.id}</div><div>مشتری: ${o.customerName}</div><div>مبلغ: ${total.toLocaleString()} تومان</div><div style="margin-top:10px" class="small">(این نسخه نمایشی است — برای چاپ از دکمه چاپ مرورگر استفاده کنید)</div>`,actions:[{t:'بستن'}]}); renderAll(); }

    function openOrderDetails(id){ const o = state.orders.find(x=>x.id===id); if(!o) return; const itemsHtml = o.items.map(i=>`<tr><td>${i.name}</td><td>${i.qty}</td><td>${i.price.toLocaleString()}</td><td>${(i.qty*i.price).toLocaleString()}</td></tr>`).join(''); const total = o.items.reduce((s,i)=>s + i.price*i.qty,0);
      openModal('جزئیات سفارش #' + id,{html:`<div style="text-align:right"><div><strong>مشتری:</strong> ${o.customerName} — ${o.customerPhone||''}</div><div class="small">تاریخ: ${new Date(o.createdAt).toLocaleString('fa-IR')}</div><table style="margin-top:8px"><thead><tr><th>محصول</th><th>تعداد</th><th>قیمت</th><th>جمع</th></tr></thead><tbody>${itemsHtml}</tbody></table><div style="text-align:left;margin-top:8px;font-weight:800">جمع کل: ${total.toLocaleString()} تومان</div></div>`,actions:[{t:'بستن'}]}); }

    // order form modal
    function openNewOrder(){ openModal('ثبت سفارش جدید',{html:`<div style="text-align:right">`+
      `<label>نام مشتری<input id=mo_name /></label>`+
      `<label>تلفن مشتری<input id=mo_phone /></label>`+
      `<div class=grid style='margin-top:8px'><input id=prod_name placeholder='نام محصول' /><input id=prod_price placeholder='قیمت (تومان)' /></div>`+
      `<div class=grid style='margin-top:8px'><input id=prod_qty placeholder='تعداد' /><button id=addItem class='btn' style='width:100%'>افزودن محصول</button></div>`+
      `<div style='margin-top:8px'><div class='small'>فهرست محصولات</div><div id=itemsList style='margin-top:8px'></div></div>`+
      `</div>`,actions:[{t:'ثبت سفارش',fn:()=>{
        const name = document.getElementById('mo_name').value.trim(); if(!name) return alert('نام مشتری لازم است');
        const items = window.__os_new_items || []; if(!items.length) return alert('حداقل یک محصول اضافه کنید');
        const id = (state.orders.length?Math.max(...state.orders.map(o=>o.id))+1:1001);
        const order = {id, customerName:name,customerPhone:document.getElementById('mo_phone').value.trim(),items,createdAt:Date.now(),status:'requested'};
        state.orders.push(order); saveAll(); addLog(`سفارش جدید ثبت شد #${id}`); closeModal(); renderAll(); }},{t:'لغو'}]});
      // add product handler
      setTimeout(()=>{
        window.__os_new_items = [];
        const il = document.getElementById('itemsList'); const addItem = document.getElementById('addItem'); addItem.onclick = ()=>{ const n=document.getElementById('prod_name').value.trim(); const p=Number(document.getElementById('prod_price').value||0); const q=Number(document.getElementById('prod_qty').value||1); if(!n || !p) return alert('نام و قیمت محصول لازم است'); window.__os_new_items.push({name:n,price:p,qty:q}); document.getElementById('prod_name').value=''; document.getElementById('prod_price').value=''; document.getElementById('prod_qty').value='1'; renderItems(); }
        function renderItems(){ il.innerHTML = window.__os_new_items.map((it,i)=>`<div style=\"display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.01);margin-bottom:6px\">${it.name} — ${it.qty} × ${it.price.toLocaleString()}<button class=\"btn ghost\" data-i=\"${i}\">حذف</button></div>`).join(''); Array.from(il.querySelectorAll('button[data-i]')).forEach(b=>b.onclick=()=>{window.__os_new_items.splice(Number(b.dataset.i),1);renderItems()}); }
      },50);
    }

    // modal utilities
    function openModal(title,opts){ const root = el('modalRoot'); root.innerHTML = `<div style="position:fixed;inset:0;background:rgba(1,6,12,0.55);display:flex;align-items:center;justify-content:center;z-index:999"><div style="width:720px;max-width:96%;direction:rtl">`+
      `<div class=card style=\"padding:16px\"><div style=\"display:flex;justify-content:space-between;align-items:center\"><div><h3 style=\"margin:0\">${title}</h3><div class=\"small\">${opts.subtitle||''}</div></div><div><button id=modalClose class=\"btn ghost\">×</button></div></div>`+
      `<div id=modalContent style=\"margin-top:12px;text-align:right\">${opts.html||''}</div>`+
      `<div style=\"margin-top:12px;display:flex;justify-content:flex-end;gap:8px\">`+
      (opts.actions? opts.actions.map(a=>`<button class=\"btn\" data-action=\"${a.t}\">${a.t}</button>`).join('') : '')+
      `</div></div></div></div>`;
      // attach handlers
      document.getElementById('modalClose').onclick = closeModal;
      Array.from(document.querySelectorAll('[data-action]')).forEach(btn=>{ btn.onclick = ()=>{ const label=btn.dataset.action; const act = (opts.actions||[]).find(x=>x.t===label); if(act && act.fn) act.fn(); else closeModal(); } });
    }
    function closeModal(){ document.getElementById('modalRoot').innerHTML=''; }

    // auth modals
    function openAuth(){ openModal('ورود / ثبت‌نام',{html:`<div style='text-align:right'>`+
      `<div style='display:flex;gap:8px'><button id='showLogin' class='btn'>ورود</button><button id='showReg' class='btn ghost'>ثبت‌نام</button></div>`+
      `<div id='authArea' style='margin-top:10px'></div>`+
      `</div>`,actions:[]});
      setTimeout(()=>{ document.getElementById('showLogin').onclick = showLogin; document.getElementById('showReg').onclick = showReg; showLogin(); },50);
    }
    function showLogin(){ const area = document.getElementById('authArea'); area.innerHTML = `<label>نام کاربری<input id='login_user' /></label><label>رمز عبور<input id='login_pass' type='password' /></label><div style='margin-top:8px;display:flex;justify-content:flex-end;gap:8px'><button id='doLogin' class='btn'>ورود</button></div>`; setTimeout(()=>{ document.getElementById('doLogin').onclick = doLogin; },50); }
    function showReg(){ const area = document.getElementById('authArea'); const captcha = Math.floor(1000 + Math.random()*9000); area.innerHTML = `<label>نام<input id='reg_name' /></label><label>نام خانوادگی<input id='reg_family' /></label><label>کد ملی<input id='reg_national' /></label><label>شماره همراه<input id='reg_phone' /></label><label>نام کاربری<input id='reg_username' /></label><label>رمز عبور<input id='reg_pass' type='password' /></label><label>کد امنیتی <div style='display:flex;gap:8px;align-items:center'><input id='reg_captcha' /><div class='badge status-sales' style='padding:6px 10px'>${captcha}</div></div></label><div style='margin-top:8px;display:flex;justify-content:flex-end;gap:8px'><button id='doReg' class='btn'>ثبت‌نام</button></div>`;
      setTimeout(()=>{ document.getElementById('doReg').onclick = ()=>{
        const data = {name:el('reg_name').value.trim(),family:el('reg_family').value.trim(),national:el('reg_national').value.trim(),phone:el('reg_phone').value.trim(),username:el('reg_username').value.trim(),password:el('reg_pass').value};
        const entered = el('reg_captcha').value.trim(); if(!data.name||!data.family||!data.national||!data.phone||!data.username||!data.password) return alert('همه فیلدها لازم است');
        if(entered !== String(captcha)) return alert('کد امنیتی اشتباه است');
        const users = DB.load(DB.usersKey,[]);
        if(users.find(u=>u.username===data.username)) return alert('نام کاربری تکراری است');
        data.id = users.length?Math.max(...users.map(u=>u.id))+1:1; users.push(data); DB.save(DB.usersKey,users); alert('ثبت‌نام با موفقیت انجام شد — اکنون وارد می‌شوید'); state.currentUser = data; DB.save(DB.currentKey,data); renderWelcome(); closeModal(); }
      },50);
    }

    function doLogin(){ const u = el('login_user').value.trim(); const p = el('login_pass').value; const users = DB.load(DB.usersKey,[]); const found = users.find(x=>x.username===u && x.password===p); if(!found) return alert('نام کاربری یا رمز اشتباه'); state.currentUser = found; DB.save(DB.currentKey,found); addLog('ورود کاربر: ' + found.username); renderAll(); closeModal(); }

    // logout
    el('btnOpenRegister').onclick = openAuth;
    el('btnLogout').onclick = ()=>{ state.currentUser=null; DB.save(DB.currentKey,null); renderWelcome(); addLog('خروج از حساب'); renderAll(); }

    // wire interactions
    el('btnNewOrder').onclick = ()=>{ if(!state.currentUser) return openAuth(); openNewOrder(); }
    el('searchOrder').oninput = ()=>renderAll(); el('filterStatus').onchange = ()=>renderAll(); actorSelect.onchange = ()=>{ state.actor = actorSelect.value; renderAll(); }

    // modal api already defined
    function renderAll(){ renderWelcome(); renderRecent(); renderOrders(el('filterStatus').value); renderLog(); }

    // initial
    renderAll();
    // expose utility to global for debugging
    window.os_state = state; window.os_db = DB;
  </script>
</body>
</html>
